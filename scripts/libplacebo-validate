#!/bin/sh
set -e

echo â³ Validating libplacebo...

BUILD="$(pwd)"
echo Build dir: $BUILD
export PKG_CONFIG_PATH="$BUILD/build_libs/lib/pkgconfig:$PKG_CONFIG_PATH"
echo PKG_CONFIG_PATH: $PKG_CONFIG_PATH

# Check if libplacebo.pc exists
if [ -f "$PKG_CONFIG_PATH/libplacebo.pc" ]; then
    echo "âœ… libplacebo.pc found in $PKG_CONFIG_PATH"
else
    echo "âŒ libplacebo.pc NOT found in $PKG_CONFIG_PATH"
    exit 1
fi

# Display contents of libplacebo.pc
echo "ğŸ“œ Contents of libplacebo.pc:"
cat "$PKG_CONFIG_PATH/libplacebo.pc"

# Check if pkg-config detects libplacebo
if pkg-config --exists libplacebo; then
    echo "âœ… pkg-config successfully detects libplacebo"
else
    echo "âŒ pkg-config CANNOT find libplacebo"
fi

# Get detailed info
echo "ğŸ“Œ libplacebo version:"
pkg-config --modversion libplacebo

echo "ğŸ”§ Compile flags:"
pkg-config --cflags libplacebo

echo "ğŸ”— Linker flags:"
pkg-config --libs libplacebo

# Debug issues
echo "ğŸ›  Debugging potential issues..."

# Check if PKG_CONFIG_PATH is correctly set
if echo "$PKG_CONFIG_PATH" | grep -q "$BUILD/build_libs/lib/pkgconfig"; then
    echo "âœ… PKG_CONFIG_PATH is correctly set: $PKG_CONFIG_PATH"
else
    echo "âŒ PKG_CONFIG_PATH is missing $BUILD/build_libs/lib/pkgconfig. Try exporting it manually."
fi

# Check for missing dependencies
MISSING_DEPS=$(pkg-config --print-requires libplacebo 2>&1 | grep "not found")

if [ -n "$MISSING_DEPS" ]; then
    echo "âš ï¸ Missing dependencies detected:"
    echo "$MISSING_DEPS"
else
    echo "âœ… No missing dependencies detected."
fi

echo "ğŸ¯ LIBPLACEBO validation script execution complete."
