#!/bin/sh
set -e

BUILD="$(pwd)"
echo "############## LIBPLACEBO-CONFIG BUILD DIR: $BUILD ##############"
newline="
"

if test -f "$BUILD"/libplacebo_options ; then
    IFS=$newline
    set -- $(cat "$BUILD"/libplacebo_options) "$@"
    unset -v IFS
fi

OPTIONS="-Ddefault_library=static -Dtests=false -Ddemos=false"

case "$PKG_CONFIG_PATH" in
  '')
    export PKG_CONFIG_PATH="$BUILD/build_libs/lib/pkgconfig"
    ;;
  *)
    export PKG_CONFIG_PATH="$BUILD/build_libs/lib/pkgconfig:$PKG_CONFIG_PATH"
    ;;
esac

cd "$BUILD"/libplacebo

test -d build && OPTIONS="$OPTIONS --wipe"
echo Using libplacebo options: $OPTIONS "$@"

meson setup build --prefix="$BUILD/build_libs" --libdir="$BUILD/build_libs/lib" $OPTIONS "$@"

# Check if libplacebo.pc exists in any of the PKG_CONFIG_PATH directories
FOUND_PC_FILE=""
IFS=':' read -ra DIRS <<< "$PKG_CONFIG_PATH"
for DIR in "${DIRS[@]}"; do
    if [ -f "$DIR/libplacebo.pc" ]; then
        FOUND_PC_FILE="$DIR/libplacebo.pc"
        break
    fi
done

if [ -n "$FOUND_PC_FILE" ]; then
    echo "‚úÖ libplacebo.pc found at: $FOUND_PC_FILE"
else
    echo "‚ùå libplacebo.pc NOT found in PKG_CONFIG_PATH directories"
    exit 1
fi

# Display contents of libplacebo.pc
echo "üìú Contents of libplacebo.pc:"
cat "$FOUND_PC_FILE"

# Check if pkg-config detects libplacebo
if pkg-config --exists libplacebo; then
    echo "‚úÖ pkg-config successfully detects libplacebo"
else
    echo "‚ùå pkg-config CANNOT find libplacebo"
fi

# Get detailed info
echo "üìå libplacebo version:"
pkg-config --modversion libplacebo

echo "üîß Compile flags:"
pkg-config --cflags libplacebo

echo "üîó Linker flags:"
pkg-config --libs libplacebo

# Debug issues
echo "üõ† Debugging potential issues..."

# Check if PKG_CONFIG_PATH includes valid directories
echo "üìÇ PKG_CONFIG_PATH is currently set to:"
echo "$PKG_CONFIG_PATH" | tr ':' '\n'  # Print each path on a new line for clarity

# Check for missing dependencies
MISSING_DEPS=$(pkg-config --print-requires libplacebo 2>&1 | grep "not found")

if [ -n "$MISSING_DEPS" ]; then
    echo "‚ö†Ô∏è Missing dependencies detected:"
    echo "$MISSING_DEPS"
else
    echo "‚úÖ No missing dependencies detected."
fi
