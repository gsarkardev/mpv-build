#!/bin/sh
set -e

BUILD="$(pwd)"
echo "############## LIBPLACEBO-CONFIG BUILD DIR: $BUILD ##############"
newline="
"

if test -f "$BUILD"/libplacebo_options ; then
    IFS=$newline
    set -- $(cat "$BUILD"/libplacebo_options) "$@"
    unset -v IFS
fi

OPTIONS="-Ddefault_library=static -Dtests=false -Ddemos=false"

case "$PKG_CONFIG_PATH" in
  '')
    export PKG_CONFIG_PATH="$BUILD/build_libs/lib/pkgconfig"
    ;;
  *)
    export PKG_CONFIG_PATH="$BUILD/build_libs/lib/pkgconfig:$PKG_CONFIG_PATH"
    ;;
esac

cd "$BUILD"/libplacebo

test -d build && OPTIONS="$OPTIONS --wipe"
echo Using libplacebo options: $OPTIONS "$@"

meson setup build --prefix="$BUILD/build_libs" --libdir="$BUILD/build_libs/lib" $OPTIONS "$@"

# Check if libplacebo.pc exists
if [ -f "$PKG_CONFIG_DIR/libplacebo.pc" ]; then
    echo "‚úÖ libplacebo.pc found in $PKG_CONFIG_DIR"
else
    echo "‚ùå libplacebo.pc NOT found in $PKG_CONFIG_DIR"
    exit 1
fi

# Display contents of libplacebo.pc
echo "üìú Contents of libplacebo.pc:"
cat "$PKG_CONFIG_DIR/libplacebo.pc"

# Check if pkg-config detects libplacebo
if pkg-config --exists libplacebo; then
    echo "‚úÖ pkg-config successfully detects libplacebo"
else
    echo "‚ùå pkg-config CANNOT find libplacebo"
fi

# Get detailed info
echo "üìå libplacebo version:"
pkg-config --modversion libplacebo

echo "üîß Compile flags:"
pkg-config --cflags libplacebo

echo "üîó Linker flags:"
pkg-config --libs libplacebo

# Debug issues
echo "üõ† Debugging potential issues..."

# Check if PKG_CONFIG_PATH is correctly set
if echo "$PKG_CONFIG_PATH" | grep -q "$PKG_CONFIG_DIR"; then
    echo "‚úÖ PKG_CONFIG_PATH is correctly set: $PKG_CONFIG_PATH"
else
    echo "‚ùå PKG_CONFIG_PATH is missing $PKG_CONFIG_DIR. Try exporting it manually."
fi

# Check for missing dependencies
MISSING_DEPS=$(pkg-config --print-requires libplacebo 2>&1 | grep "not found")

if [ -n "$MISSING_DEPS" ]; then
    echo "‚ö†Ô∏è Missing dependencies detected:"
    echo "$MISSING_DEPS"
else
    echo "‚úÖ No missing dependencies detected."
fi
